<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PRO - Pakistan Recovery Oasis HMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Manrope:wght@500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');

      :root {
        --shamrock: #4ade80;
        --shamrock-strong: #22c55e;
        --forest: #0f3c2d;
        --amber: #f59e0b;
        --sky: #1d9bf0;
        --surface: #f5f7f8;
        --card: #ffffff;
        --text-main: #122024;
        --text-muted: #4b5563;
        --border-soft: #e5e7eb;
      }
      .urdu-text {
        font-family: 'Noto Nastaliq Urdu', 'Arial', sans-serif;
        direction: rtl;
        text-align: right;
        line-height: 1.8;
      }

      /* --- CALENDAR STYLES --- */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        text-align: center;
        font-size: 0.8rem;
        margin-top: 10px;
      }
      .calendar-day-header {
        font-weight: bold;
        color: #555;
        padding-bottom: 4px;
      }
      .calendar-day {
        padding: 6px;
        border-radius: 4px;
        background-color: #f9fafb;
      }
      .calendar-day.today {
        border: 2px solid #166534;
      }
      .calendar-day.call-day {
        background-color: #dcfce7;
        color: #166534;
        font-weight: bold;
        border: 1px solid #166534;
      }

      /* --- PRINT STYLES --- */
      @media print {
        body * {
          visibility: hidden;
        }

        /* Visible Areas */
        #printable-area,
        #printable-area * {
          visibility: visible;
        }
        #printable-discharge-slip,
        #printable-discharge-slip * {
          visibility: visible;
        }

        .fas, .far, .fab, .fa {
          visibility: visible !important;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }

        /* Positioning */
        #printable-area {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }
        #printable-discharge-slip {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          background: white;
          color: black;
          padding: 40px;
        }

        .no-print {
          display: none !important;
        }
        .page-break {
          page-break-after: always;
        }

        /* Discharge Slip Table */
        .discharge-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
        }
        .discharge-table th,
        .discharge-table td {
          border: 1px solid black;
          padding: 8px;
          text-align: left;
          font-size: 14px;
        }
        .discharge-header {
          margin-bottom: 30px;
          font-size: 16px;
          line-height: 2;
        }

        /* Original Profile Print Styles */
        .print-container {
          padding: 20px;
          font-family: 'Times New Roman', serif;
        }
        .print-header {
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 20px;
          border-bottom: 2px solid #166534;
          padding-bottom: 10px;
          gap: 20px;
        }
        .print-logo-icon {
          font-size: 40pt;
          color: #166534;
        }
        .print-title-block {
          text-align: left;
        }
        .print-pro {
          font-size: 36pt;
          font-weight: bold;
          color: #166534;
          line-height: 1;
          letter-spacing: 2px;
        }
        .print-sub-pro {
          font-size: 14pt;
          font-weight: bold;
          color: #333;
          text-transform: uppercase;
          letter-spacing: 1px;
        }
        .print-tagline {
          font-size: 10pt;
          color: #555;
        }
        .print-row {
          display: flex;
          margin-bottom: 8px;
          border-bottom: 1px dotted #ccc;
          padding-bottom: 2px;
        }
        .print-label {
          font-weight: bold;
          width: 180px;
        }
        .print-value {
          flex: 1;
        }
        .print-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
        }
        .print-table th,
        .print-table td {
          border: 1px solid black;
          padding: 5px;
          text-align: left;
          font-size: 10pt;
        }
        .urdu-row {
          margin-bottom: 15px;
        }
        .box-section {
          border: 1px solid black;
          padding: 10px;
          margin-top: 20px;
          border-radius: 5px;
        }
      }

      #printable-area,
      #printable-discharge-slip {
        display: none;
      }
      @media print {
        .print-active {
          display: block !important;
        }
      }

      /* Sidebar Transition */
      .sidebar-transition {
        transition: transform 0.3s ease-in-out;
      }

      body {
        font-family: 'DM Sans', 'Inter', system-ui, -apple-system, sans-serif;
        color: var(--text-main);
        background: linear-gradient(180deg, #f7f9fa 0%, #f3f9f5 45%, #f8fcf9 100%);
      }
      .metric-number {
        font-family: 'Manrope', 'Inter', system-ui, sans-serif;
      }

      /* --- DASHBOARD STYLES --- */
      .kpi-card {
        position: relative;
        border-radius: 16px;
        padding: 18px;
        color: #0f172a;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.08);
        border: 1px solid rgba(17, 24, 39, 0.04);
        overflow: hidden;
        background: linear-gradient(135deg, #ffffff 0%, #f7fdf9 100%);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }
      .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 36px rgba(16, 185, 129, 0.15);
        transition: all 0.25s ease;
      }
      .kpi-card .kpi-icon {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #0f172a;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.15);
      }
      .kpi-accent-shamrock {
        background: linear-gradient(135deg, #a4f4c9 0%, #74e6ad 100%);
        color: #065f46;
      }
      .kpi-accent-sky {
        background: linear-gradient(135deg, #e0f2ff 0%, #b7e0ff 100%);
        color: #0f172a;
      }
      .kpi-accent-amber {
        background: linear-gradient(135deg, #fff7e6 0%, #ffe8c2 100%);
        color: #78350f;
      }
      .kpi-accent-forest {
        background: linear-gradient(135deg, #e6f4ef 0%, #c8efe1 100%);
        color: #0f3c2d;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 13px;
        border: 1px solid var(--border-soft);
        background: rgba(255, 255, 255, 0.7);
        color: var(--text-muted);
      }
      .pill.active {
        border-color: rgba(34, 197, 94, 0.45);
        background: rgba(74, 222, 128, 0.12);
        color: #065f46;
      }

      .panel-card {
        background: #ffffff;
        border-radius: 18px;
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.06);
        border: 1px solid rgba(17, 24, 39, 0.04);
      }
    </style>
    <script>
      let patientsData = [];
      let accountsData = [];
      let teamData = [];
      let currentPatientId = null;
      let currentUser = { isLoggedIn: false, role: 'Guest', username: '' };

      const formatCurrency = (amount) =>
        new Intl.NumberFormat('en-PK', {
          style: 'currency',
          currency: 'PKR',
          minimumFractionDigits: 0,
        }).format(amount);
      const formatNumber = (num) => new Intl.NumberFormat('en-US').format(num);

      // --- AUTH & SETUP ---
      async function initApp() {
        if (await checkSession()) {
          updateNavVisibility();
          await fetchPatients();
          window.navigateTo('dashboard-view');
        } else {
          window.navigateTo('login-view');
        }
      }

      async function checkSession() {
        try {
          const res = await fetch('/api/auth/session');
          if (res.ok) {
            const data = await res.json();
            if (data.is_logged_in) {
              currentUser = data;
              document.getElementById('logged-in-user').innerText = `${data.name} (${data.role})`;
              return true;
            }
          }
        } catch (e) {
          console.error('Session check error:', e);
        }
        currentUser = { isLoggedIn: false, role: 'Guest', username: '' };
        return false;
      }

      function updateNavVisibility() {
        const navMap = {
          'nav-canteen': ['Admin', 'Canteen'],
          'nav-expenses': ['Admin'],
          'nav-users': ['Admin'],
          'nav-accounts': ['Admin'],
          'nav-bills': ['Admin'],
          'nav-team': ['Admin'],
        };

        for (const [id, roles] of Object.entries(navMap)) {
          const el = document.getElementById(id);
          if (el) el.style.display = roles.includes(currentUser.role) ? 'block' : 'none';
        }

        const newPatientBtn = document.getElementById('add-new-patient-btn');
        if (newPatientBtn)
          newPatientBtn.style.display =
            currentUser.role === 'Admin' || currentUser.role === 'Doctor' ? 'flex' : 'none';

        const addExpenseBtn = document.getElementById('add-expense-btn');
        if (addExpenseBtn)
          addExpenseBtn.style.display = currentUser.role === 'Admin' ? 'inline-flex' : 'none';

        // Financial Inputs in Details
        const isAdmin = currentUser.role === 'Admin';
        document.querySelectorAll('.financial-input').forEach((el) => {
          el.disabled = !isAdmin;
          if (!isAdmin) el.classList.add('bg-gray-100', 'cursor-not-allowed');
          else el.classList.remove('bg-gray-100', 'cursor-not-allowed');
        });
      }

      function toggleSidebar() {
        const sidebar = document.getElementById('main-sidebar');
        if (sidebar.classList.contains('-translate-x-full')) {
          sidebar.classList.remove('-translate-x-full');
        } else {
          sidebar.classList.add('-translate-x-full');
        }
      }

      window.handleLogin = async function (e) {
        e.preventDefault();
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        try {
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          if (res.ok) {
            await initApp();
          } else {
            showSuccessModal('Login failed.', true);
          }
        } catch (e) {
          showSuccessModal('Login error.', true);
        }
      };

      window.handleLogout = async function () {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.reload();
      };

      window.navigateTo = function (viewId) {
        if (viewId === 'accounts-view' && currentUser.role !== 'Admin') {
          showSuccessModal('Access Denied.', true);
          return;
        }

        // Hide all views
        document.querySelectorAll('.view-section').forEach((el) => el.classList.add('hidden'));
        // Show selected view
        const targetView = document.getElementById(viewId);
        if(targetView) targetView.classList.remove('hidden');

        // Reset Nav Styles
        document.querySelectorAll('.nav-item').forEach((el) => {
          el.classList.remove(
            'bg-emerald-200/80',
            'text-emerald-900',
            'shadow-sm',
            'border',
            'border-emerald-200'
          );
          el.classList.add('text-emerald-800', 'border', 'border-transparent');
        });

        // Map Views to Buttons
        const navIdMap = {
          'dashboard-view': 'nav-dash',
          'patients-view': 'nav-patients',
          'expenses-view': 'nav-expenses',
          'canteen-view': 'nav-canteen',
          'user-management-view': 'nav-users',
          'accounts-view': 'nav-accounts',
          'utility-bills-view': 'nav-bills',
          'team-view': 'nav-team',
        };
        
        const navId = navIdMap[viewId];
        const navEl = document.getElementById(navId);
        if (navEl) {
          navEl.classList.remove('text-emerald-800', 'border-transparent');
          navEl.classList.add(
            'bg-emerald-200/80',
            'text-emerald-900',
            'shadow-sm',
            'border-emerald-200'
          );
        }

        // Close sidebar on mobile
        const sidebar = document.getElementById('main-sidebar');
        if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
          sidebar.classList.add('-translate-x-full');
        }

        // Logic per view
        if (viewId === 'dashboard-view') {
          updateDashboard();
          loadCallMeetingData();
          updateDateTime();
          if (window.dateTimeInterval) clearInterval(window.dateTimeInterval);
          window.dateTimeInterval = setInterval(updateDateTime, 1000);
        }
        if (viewId === 'expenses-view') loadExpenses();
        if (viewId === 'canteen-view') renderCanteenBreakdown();
        if (viewId === 'user-management-view') renderUserManagement();
        if (viewId === 'accounts-view') renderAccounts();
        if (viewId === 'utility-bills-view') renderUtilityBills();
        if (viewId === 'team-view') renderTeam();
      };

      // --- LOGIC FUNCTIONS (Unchanged logic, just responsive support) ---
      // (Keeping all logic functions same as provided in previous steps for brevity, just ensure they are present)
      
      // --- UTILITY BILLS LOGIC ---
      async function renderUtilityBills() {
        if (currentUser.role !== 'Admin') return;
        try {
          const res = await fetch('/api/utility_bills');
          const bills = await res.json();
          const grid = document.getElementById('bills-grid');
          const emptyState = document.getElementById('bills-empty-state');
          const totalDisplay = document.getElementById('bill-total-display');
          
          grid.innerHTML = '';
          let total = 0;
          if (bills.length === 0) {
            emptyState.classList.remove('hidden');
            totalDisplay.innerText = formatCurrency(0);
            return;
          } else {
            emptyState.classList.add('hidden');
          }
          bills.forEach(b => {
            total += b.amount;
            let iconClass = 'fa-file-invoice';
            let colorClass = 'bg-gray-100 text-gray-600';
            if(b.type === 'Electricity') { iconClass = 'fa-bolt'; colorClass = 'bg-yellow-100 text-yellow-600'; }
            else if(b.type === 'Gas') { iconClass = 'fa-fire'; colorClass = 'bg-orange-100 text-orange-600'; }
            else if(b.type === 'Water') { iconClass = 'fa-tint'; colorClass = 'bg-blue-100 text-blue-600'; }
            else if(b.type === 'Internet') { iconClass = 'fa-wifi'; colorClass = 'bg-indigo-100 text-indigo-600'; }

            const card = document.createElement('div');
            card.className = "bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition relative group";
            card.innerHTML = `
              <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center shadow-sm">
                    <i class="fas ${iconClass}"></i>
                  </div>
                  <div>
                    <h4 class="font-bold text-gray-800">${b.type}</h4>
                    <div class="text-xs text-gray-500">${b.ref_no || 'No Ref'}</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="font-extrabold text-lg text-gray-800">${formatCurrency(b.amount)}</div>
                  <div class="text-xs font-semibold text-red-500">Due: ${b.due_date}</div>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-gray-100 flex justify-end">
                <button onclick="payUtilityBill('${b.id}')" class="bg-green-50 text-green-700 hover:bg-green-600 hover:text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                  <i class="fas fa-check"></i> Mark Paid
                </button>
              </div>
            `;
            grid.appendChild(card);
          });
          totalDisplay.innerText = formatCurrency(total);
        } catch (e) {
          console.error("Bills Render Error:", e);
        }
      }
      async function addUtilityBill(e) {
        e.preventDefault();
        const data = {
          type: document.getElementById('bill-type').value,
          amount: document.getElementById('bill-amount').value,
          due_date: document.getElementById('bill-due-date').value,
          ref_no: document.getElementById('bill-ref').value
        };
        const res = await fetch('/api/utility_bills', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        if(res.ok) { showSuccessModal('Bill Added Successfully'); e.target.reset(); renderUtilityBills(); } else { showSuccessModal('Error adding bill', true); }
      }
      async function payUtilityBill(id) {
        if(!(await showConfirmModal("Mark this bill as paid? This will move it to Expenses."))) return;
        const res = await fetch(`/api/utility_bills/${id}`, { method: 'DELETE' });
        if(res.ok) { showSuccessModal('Bill Paid & Recorded'); renderUtilityBills(); } else { showSuccessModal('Error paying bill', true); }
      }

      // --- TEAM MANAGEMENT LOGIC ---
      async function renderTeam() {
        if (currentUser.role !== 'Admin') return;
        try {
          const res = await fetch('/api/employees');
          const employees = await res.json();
          teamData = employees;
          const tbody = document.getElementById('team-table-body');
          tbody.innerHTML = '';
          if (employees.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="p-6 text-center text-gray-400">No team members added yet.</td></tr>';
            return;
          }
          employees.forEach((emp, index) => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-emerald-50/50 transition border-b border-gray-100";
            tr.innerHTML = `
              <td class="px-4 py-3 text-center text-gray-500 font-mono text-xs">${index + 1}</td>
              <td class="px-4 py-3 font-semibold text-gray-800">${emp.name}</td>
              <td class="px-4 py-3 text-emerald-700 font-medium text-sm bg-emerald-50/30 rounded whitespace-nowrap">${emp.designation}</td>
              <td class="px-4 py-3 text-gray-600 text-sm whitespace-nowrap">${emp.pay || '-'}</td>
              <td class="px-4 py-3 text-gray-600 text-sm whitespace-nowrap">${emp.advance || '-'}</td>
              <td class="px-4 py-3 text-gray-600 text-sm whitespace-nowrap">${emp.duty_timings || '-'}</td>
              <td class="px-4 py-3 text-gray-600 text-sm whitespace-nowrap">${emp.date_of_joining || '-'}</td>
              <td class="px-4 py-3 text-xs whitespace-nowrap">
                <div class="text-gray-900 font-bold">${emp.phone || ''}</div>
                <div class="text-gray-500">${emp.cnic || ''}</div>
              </td>
              <td class="px-4 py-3 text-center whitespace-nowrap">
                <button onclick="editEmployee('${emp.id}')" class="text-blue-600 hover:text-blue-800 p-2" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteEmployee('${emp.id}')" class="text-red-500 hover:text-red-700 p-2" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (e) {
          console.error("Team Render Error:", e);
        }
      }
      function openEmployeeModal() {
        document.getElementById('employee-form').reset();
        document.getElementById('emp-id').value = '';
        document.getElementById('emp-modal-title').innerHTML = '<i class="fas fa-user-tie mr-2"></i>Add Employee';
        document.getElementById('employee-modal').classList.remove('hidden');
      }
      function closeEmployeeModal() { document.getElementById('employee-modal').classList.add('hidden'); }
      function editEmployee(id) {
        const emp = teamData.find(e => e.id === id);
        if (!emp) return;
        document.getElementById('emp-id').value = emp.id;
        document.getElementById('emp-name').value = emp.name;
        document.getElementById('emp-designation').value = emp.designation;
        document.getElementById('emp-pay').value = emp.pay;
        document.getElementById('emp-advance').value = emp.advance;
        document.getElementById('emp-timings').value = emp.duty_timings;
        document.getElementById('emp-joining').value = emp.date_of_joining;
        document.getElementById('emp-cnic').value = emp.cnic;
        document.getElementById('emp-phone').value = emp.phone;
        document.getElementById('emp-modal-title').innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Employee';
        document.getElementById('employee-modal').classList.remove('hidden');
      }
      async function saveEmployee(e) {
        e.preventDefault();
        const id = document.getElementById('emp-id').value;
        const data = {
          name: document.getElementById('emp-name').value,
          designation: document.getElementById('emp-designation').value,
          pay: document.getElementById('emp-pay').value,
          advance: document.getElementById('emp-advance').value,
          duty_timings: document.getElementById('emp-timings').value,
          date_of_joining: document.getElementById('emp-joining').value,
          cnic: document.getElementById('emp-cnic').value,
          phone: document.getElementById('emp-phone').value
        };
        let method = 'POST'; let url = '/api/employees';
        if (id) { method = 'PUT'; url = `/api/employees/${id}`; }
        const res = await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        if(res.ok) { showSuccessModal(id ? 'Employee Updated' : 'Employee Added'); closeEmployeeModal(); renderTeam(); } else { showSuccessModal('Operation failed', true); }
      }
      async function deleteEmployee(id) {
        if(!(await showConfirmModal("Remove this employee from the team?"))) return;
        const res = await fetch(`/api/employees/${id}`, { method: 'DELETE' });
        if(res.ok) { showSuccessModal('Employee Removed'); renderTeam(); } else { showSuccessModal('Error removing employee', true); }
      }

      // --- EXISTING LOGIC RE-INTEGRATED ---
      window.callMeetingChart = null;
      let currentCallMeetingRecords = [];

      window.printCallMeetingChart = function () {
        if (!currentCallMeetingRecords || currentCallMeetingRecords.length === 0) {
          showSuccessModal('No data to print.', true);
          return;
        }
        const printWindow = window.open('', '', 'width=900,height=600');
        const today = new Date();
        const formattedDate = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        let tableHTML = `<html><head><title>Call & Meeting Report</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:8px;text-align:left}th{background:#f0f0f0}</style></head><body><h1>Call Log (${formattedDate})</h1><table><thead><tr><th>Name</th><th>Type</th><th>Date</th></tr></thead><tbody>`;
        currentCallMeetingRecords.forEach(r => { tableHTML += `<tr><td>${r.name}</td><td>${r.type}</td><td>${getFormattedDateFromDay(r.day, r.month, r.year)}</td></tr>`; });
        tableHTML += `</tbody></table></body></html>`;
        printWindow.document.write(tableHTML);
        printWindow.document.close();
        printWindow.print();
      };

      async function loadCallMeetingData() {
        try {
          const today = new Date(); const month = today.getMonth() + 1; const year = today.getFullYear();
          const res = await fetch('/api/call_meeting_tracker'); if (!res.ok) return;
          const records = await res.json();
          const summaryRes = await fetch(`/api/call_meeting_tracker/summary/${month}/${year}`); const summary = await summaryRes.json();
          document.getElementById('stat-calls').innerText = summary.totalCalls || 0;
          document.getElementById('stat-meetings').innerText = summary.totalMeetings || 0;
          document.getElementById('stat-texts').innerText = summary.totalTexts || 0;
          renderCallMeetingTable(records); renderCallMeetingChart(records);
        } catch (e) { console.error('Call/Meeting Load Error', e); }
      }

      function getFormattedDateFromDay(day, month, year) {
        const date = new Date(year, month - 1, day);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      }

      function renderCallMeetingTable(records) {
        const tbody = document.getElementById('call_meeting_table_body'); tbody.innerHTML = '';
        if (!records || records.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">No records found.</td></tr>'; return; }
        records.forEach((r) => {
          const tr = document.createElement('tr');
          const typeColor = { Call: 'bg-emerald-100 text-emerald-800', Meeting: 'bg-blue-100 text-blue-800', Text: 'bg-amber-100 text-amber-800' }[r.type] || 'bg-gray-100 text-gray-800';
          const formattedDate = getFormattedDateFromDay(r.day, r.month, r.year);
          tr.className = 'hover:bg-emerald-50 transition border-b border-gray-100';
          tr.innerHTML = `<td class="px-6 py-4 font-medium whitespace-nowrap text-gray-800">${r.name}</td><td class="px-6 py-4 text-gray-600 whitespace-nowrap">${r.date_of_admission}</td><td class="px-6 py-4 text-center font-semibold text-gray-700">${formattedDate}</td><td class="px-6 py-4 text-center"><span class="px-3 py-1 text-xs rounded-full font-semibold ${typeColor}">${r.type}</span></td><td class="px-6 py-4 text-center"><button onclick="openCallMeetingDeleteModal('${r._id}')" class="text-emerald-600 hover:text-emerald-800 hover:bg-emerald-100 p-2 rounded transition text-sm"><i class="fas fa-trash"></i></button></td>`;
          tbody.appendChild(tr);
        });
      }

      function renderCallMeetingChart(records) {
        currentCallMeetingRecords = records;
        if (!records || records.length === 0) return;
        const chartData = {};
        records.forEach((r) => { if (!chartData[r.day]) chartData[r.day] = { Call: 0, Meeting: 0, Text: 0 }; chartData[r.day][r.type]++; });
        const days = Object.keys(chartData).sort((a, b) => parseInt(a) - parseInt(b));
        const calls = days.map((d) => chartData[d]['Call'] || 0);
        const meetings = days.map((d) => chartData[d]['Meeting'] || 0);
        const texts = days.map((d) => chartData[d]['Text'] || 0);
        const ctx = document.getElementById('callMeetingChart').getContext('2d');
        const today = new Date();
        if (window.callMeetingChart) window.callMeetingChart.destroy();
        window.callMeetingChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: days.map((d) => getFormattedDateFromDay(d, today.getMonth() + 1, today.getFullYear())),
            datasets: [ { label: 'Calls', data: calls, backgroundColor: '#3b82f6' }, { label: 'Meetings', data: meetings, backgroundColor: '#10b981' }, { label: 'Texts', data: texts, backgroundColor: '#a855f7' } ],
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }
      
      // ... (Keeping rest of modal functions: openCallMeetingModal, saveCallMeetingEntry, etc. as they were) ...
      window.openCallMeetingModal = function () { document.getElementById('call_meeting_form').reset(); document.getElementById('call_meeting_modal').classList.remove('hidden'); };
      window.saveCallMeetingEntry = async function (e) {
        e.preventDefault();
        const name = document.getElementById('cm-name').value;
        const admissionDate = document.getElementById('cm-admission-date').value;
        const day = document.getElementById('cm-day').value;
        const type = document.getElementById('cm-type').value;
        const today = new Date(); const month = today.getMonth() + 1; const year = today.getFullYear();
        const res = await fetch('/api/call_meeting_tracker', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, date_of_admission: admissionDate, day: parseInt(day), month, year, type }) });
        if (res.ok) { document.getElementById('call_meeting_modal').classList.add('hidden'); showSuccessModal('Entry saved successfully!'); await loadCallMeetingData(); }
      };
      window.openCallMeetingDeleteModal = function (id) { window.pendingCallMeetingDeleteId = id; document.getElementById('cm-confirm-modal').classList.remove('hidden'); };
      window.closeCallMeetingDeleteModal = function () { window.pendingCallMeetingDeleteId = null; document.getElementById('cm-confirm-modal').classList.add('hidden'); };
      window.confirmDeleteCallMeeting = async function () {
        if (!window.pendingCallMeetingDeleteId) return;
        const res = await fetch(`/api/call_meeting_tracker/${window.pendingCallMeetingDeleteId}`, { method: 'DELETE' });
        if (res.ok) { showSuccessModal('Entry deleted successfully!'); await loadCallMeetingData(); }
        window.closeCallMeetingDeleteModal();
      };
      
      // ... (Keeping rest of Dashboard/Patient logic: updateDateTime, updateDashboard, fetchPatients etc.) ...
      // Ensuring vital functions are present
      function updateDateTime() {
        const now = new Date();
        const dateEl = document.getElementById('current-date'); const timeEl = document.getElementById('current-time');
        if (dateEl) dateEl.innerText = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        if (timeEl) timeEl.innerText = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      }
      async function updateDashboard() {
        try {
           const isAdmin = currentUser.role === 'Admin';
           const incomeCard = document.getElementById('dash-income-card'); const canteenCard = document.getElementById('dash-canteen-card'); const callMeetingSection = document.getElementById('dash-call-meeting-section');
           if (incomeCard) incomeCard.style.display = isAdmin ? '' : 'none';
           if (canteenCard) canteenCard.style.display = isAdmin ? '' : 'none';
           if (callMeetingSection) callMeetingSection.style.display = isAdmin ? '' : 'none';
           const res = await fetch('/api/dashboard'); if (!res.ok) return;
           const metrics = await res.json();
           const today = new Date(); const monthName = today.toLocaleDateString('en-US', { month: 'long' });
           document.getElementById('dash-total').innerText = formatNumber(metrics.totalPatients);
           document.getElementById('dash-today').innerText = formatNumber(metrics.admissionsThisMonth);
           document.getElementById('dash-income').innerText = formatCurrency(metrics.totalIncomeThisMonth);
           document.getElementById('dash-canteen-sales').innerText = formatCurrency(metrics.totalCanteenSalesThisMonth);
           document.getElementById('dash-month-label').innerText = monthName;
           document.getElementById('dash-canteen-month').innerText = monthName;
        } catch(e) { console.error(e); }
      }
      function formatDisplayDate(value) { if (!value) return '-'; const d = new Date(value); if (isNaN(d.getTime())) return value; return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
      
      // ... (Patient, Expense, Account logic remains same but ensuring render functions are hooked up correctly)
      async function fetchPatients() {
        try { const res = await fetch('/api/patients'); if (res.ok) { patientsData = await res.json(); renderPatientsTable(patientsData); } } catch(e) {}
      }
      function renderPatientsTable(list) {
         const tbody = document.getElementById('patients-table-body'); tbody.innerHTML = '';
         if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-400">No records found.</td></tr>'; return; }
         list.forEach(p => {
           const id = p._id || p.id; const fee = formatCurrency(parseInt(p.monthlyFee.replace(/,/g, '') || 0));
           const tr = document.createElement('tr'); tr.className = 'hover:bg-gray-50 border-b cursor-pointer transition'; tr.onclick = (e) => { if (e.target.closest('.action-btn')) return; showPatientDetail(id); };
           const isAdmin = currentUser.role === 'Admin';
           const deleteBtn = isAdmin ? `<button class="action-btn text-red-500 hover:text-red-700 transition" onclick="event.stopPropagation(); deletePatient('${id}');"><i class="fas fa-trash"></i></button>` : '';
           if(isAdmin) {
             tr.innerHTML = `<td class="px-6 py-4 font-medium whitespace-nowrap">${p.name}</td><td class="px-6 py-4 text-gray-500 whitespace-nowrap">${p.idNo||'-'}</td><td class="px-6 py-4 text-gray-500 whitespace-nowrap">${p.contactNo||'-'}</td><td class="px-6 py-4 font-semibold text-green-700 whitespace-nowrap">${fee}</td><td class="px-6 py-4 text-center"><span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Active</span></td><td class="px-6 py-4 text-right">${deleteBtn}</td>`;
           } else {
             tr.innerHTML = `<td class="px-6 py-4 font-medium whitespace-nowrap">${p.name}</td><td class="px-6 py-4 text-center"><span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Active</span></td><td class="px-6 py-4 text-right"></td>`;
           }
           tbody.appendChild(tr);
         });
      }
      // Re-attaching necessary helpers for patient add/edit which were already in original
      window.addNewPatient = async function (e) {
        e.preventDefault();
        const formData = {
           name: document.getElementById('new-patient-name').value,
           fatherName: document.getElementById('new-patient-father').value,
           admissionDate: document.getElementById('new-patient-admission').value,
           age: document.getElementById('new-patient-age').value,
           cnic: document.getElementById('new-patient-cnic').value,
           contactNo: document.getElementById('new-patient-contact').value,
           guardianName: document.getElementById('new-patient-guardian').value,
           address: document.getElementById('new-patient-address').value,
           monthlyFee: document.getElementById('new-patient-fee').value || '0',
           monthlyAllowance: document.getElementById('new-patient-allowance').value || '3000',
           laundryStatus: document.getElementById('new-patient-laundry-status').checked,
           laundryAmount: document.getElementById('new-patient-laundry-amount').value || '3500',
        };
        const res = await fetch('/api/patients', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(formData) });
        if (res.ok) { document.getElementById('new-admission-modal').classList.add('hidden'); document.getElementById('new-admission-form').reset(); await fetchPatients(); showSuccessModal('Patient admitted successfully!'); }
      };

      // ... (Expense logic re-integration)
      async function loadExpenses() {
        try {
           const [listRes, summaryRes] = await Promise.all([ fetch('/api/expenses'), fetch('/api/expenses/summary') ]);
           if (summaryRes.ok) {
             const summary = await summaryRes.json();
             document.getElementById('expense-incoming').innerText = formatCurrency(summary.incoming || 0);
             document.getElementById('expense-outgoing').innerText = formatCurrency(summary.outgoing || 0);
             document.getElementById('expense-net').innerText = formatCurrency(summary.net || 0);
           }
           if (listRes.ok) renderExpensesTable(await listRes.json());
        } catch(e) {}
      }
      function renderExpensesTable(list) {
         const tbody = document.getElementById('expenses-table-body'); tbody.innerHTML = '';
         if (!list || list.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-400">No expenses recorded.</td></tr>'; return; }
         list.forEach(item => {
            const tr = document.createElement('tr');
            const typeBadge = item.type === 'incoming' ? '<span class="px-3 py-1 text-xs rounded-full font-semibold bg-emerald-100 text-emerald-800">Incoming</span>' : '<span class="px-3 py-1 text-xs rounded-full font-semibold bg-red-100 text-red-700">Outgoing</span>';
            const autoBadge = item.auto ? '<span class="ml-2 px-2 py-0.5 text-[11px] rounded-full bg-gray-100 text-gray-600 border border-gray-200">Auto</span>' : '';
            const deleteCell = item.auto ? '<span class="text-xs text-gray-400">â€”</span>' : `<button onclick="deleteExpense('${item.id}')" class="text-emerald-600 hover:text-emerald-800 text-sm px-3 py-1 rounded hover:bg-emerald-100 transition"><i class="fas fa-trash"></i></button>`;
            tr.className = 'hover:bg-emerald-50 transition border-b border-gray-100';
            tr.innerHTML = `<td class="px-6 py-4 text-gray-800 whitespace-nowrap">${formatDisplayDate(item.date)}</td><td class="px-6 py-4 text-gray-700 whitespace-nowrap">${item.category||'-'}${autoBadge}</td><td class="px-6 py-4">${typeBadge}</td><td class="px-6 py-4 text-right font-semibold text-gray-800">${formatCurrency(item.amount||0)}</td><td class="px-6 py-4 text-gray-600 whitespace-nowrap">${item.note||'-'}</td><td class="px-6 py-4 text-center">${deleteCell}</td>`;
            tbody.appendChild(tr);
         });
      }
      
      // ... (Account logic re-integration)
      async function renderAccounts() {
         if (currentUser.role !== 'Admin') return;
         try {
            const res = await fetch('/api/accounts/summary'); if (!res.ok) return;
            accountsData = await res.json();
            const tbody = document.getElementById('accounts-table-body'); tbody.innerHTML = '';
            accountsData.forEach(p => {
               const fee = formatCurrency(parseInt(p.monthlyFee.replace(/,/g, '') || 0)); const canteen = formatCurrency(p.canteenTotal);
               tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b"><td class="px-6 py-4 font-medium whitespace-nowrap">${p.name}</td><td class="px-6 py-4 whitespace-nowrap">${p.fatherName}</td><td class="px-6 py-4 whitespace-nowrap">${p.admissionDate}</td><td class="px-6 py-4 font-bold text-green-700 whitespace-nowrap">${fee}</td><td class="px-6 py-4 font-bold text-orange-600 whitespace-nowrap">${canteen}</td><td class="px-6 py-4"><button onclick="printDischargeSlip('${p.id}')" class="bg-gray-800 hover:bg-gray-900 text-white px-3 py-1 rounded text-sm shadow-md transition font-semibold"><i class="fas fa-print mr-1"></i> Discharge</button></td></tr>`;
            });
         } catch(e) {}
      }
      
      window.onload = initApp;
    </script>
  </head>
  <body class="h-screen flex flex-col md:flex-row overflow-hidden font-sans text-gray-800">
    <section id="login-view" class="view-section fixed inset-0 z-50 bg-gray-50 flex items-center justify-center">
      <div class="bg-white p-8 rounded-xl shadow-2xl w-[90%] max-w-sm mx-auto">
        <h1 class="text-3xl font-bold text-center text-green-900 mb-2"><i class="fas fa-brain"></i> PRO System</h1>
        <form onsubmit="handleLogin(event)">
          <input type="text" id="login-username" class="w-full p-3 mb-4 border rounded" placeholder="Username" required />
          <input type="password" id="login-password" class="w-full p-3 mb-6 border rounded" placeholder="Password" required />
          <button type="submit" class="w-full bg-green-600 text-white p-3 rounded font-bold hover:bg-green-700">Log In</button>
        </form>
      </div>
    </section>

    <div class="md:hidden bg-emerald-600 text-white p-4 flex justify-between items-center shadow z-50 flex-none sticky top-0">
      <h1 class="font-bold text-lg"><i class="fas fa-brain mr-2"></i> PRO System</h1>
      <button onclick="toggleSidebar()" class="focus:outline-none p-2"><i class="fas fa-bars text-xl"></i></button>
    </div>

    <aside id="main-sidebar" class="bg-gradient-to-b from-emerald-100 via-emerald-50 to-emerald-100 text-emerald-900 flex-col no-print shadow-xl border-r border-emerald-100 z-40 absolute md:relative inset-y-0 left-0 w-64 transform -translate-x-full md:translate-x-0 sidebar-transition md:flex h-full pt-16 md:pt-0">
      <div class="p-6 border-b border-emerald-100 hidden md:block">
        <h1 class="text-2xl font-bold flex items-center gap-2 text-emerald-900"><i class="fas fa-brain text-emerald-500"></i> PRO System</h1>
      </div>
      <div class="p-4 text-xs bg-emerald-50 border-b border-emerald-100 font-semibold text-emerald-800" id="logged-in-user">Guest</div>
      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <button id="nav-dash" onclick="window.navigateTo('dashboard-view')" class="nav-item w-full text-left px-4 py-3 rounded-lg bg-emerald-200/80 text-emerald-900 shadow-sm border border-emerald-200 transition">Dashboard</button>
        <button id="nav-patients" onclick="window.navigateTo('patients-view')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-emerald-800 hover:bg-emerald-100/80 border border-transparent transition">Patients Directory</button>
        <button id="nav-accounts" onclick="window.navigateTo('accounts-view')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-emerald-800 hover:bg-emerald-100/80 border border-transparent transition" style="display: none">Accounts & Discharge</button>
        <button id="nav-canteen" onclick="window.navigateTo('canteen-view')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-emerald-800 hover:bg-emerald-100/80 border border-transparent transition" style="display: none">Canteen</button>
        <button id="nav-expenses" onclick="window.navigateTo('expenses-view')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-emerald-800 hover:bg-emerald-100/80 border border-transparent transition" style="display: none">Expenses</button>
        <button id="nav-users" onclick="window.navigateTo('user-management-view')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-emerald-800 hover:bg-emerald-100/80 border border-transparent transition" style="display: none">User Management</button>
        <button id="nav-bills" onclick="window.navigateTo('utility-bills-view')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-emerald-800 hover:bg-emerald-100/80 border border-transparent transition" style="display: none">Utility Bills</button>
        <button id="nav-team" onclick="window.navigateTo('team-view')" class="nav-item w-full text-left px-4 py-3 rounded-lg text-emerald-800 hover:bg-emerald-100/80 border border-transparent transition" style="display: none">Our Team</button>
      </nav>
      <div class="p-4 border-t border-emerald-100 flex-none">
        <button onclick="document.getElementById('password-modal').classList.remove('hidden')" class="w-full text-left px-4 py-2 text-sm text-emerald-800 hover:text-emerald-900"><i class="fas fa-key mr-2"></i> Password</button>
        <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-emerald-800 hover:text-emerald-900"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button>
      </div>
    </aside>

    <main class="flex-1 overflow-auto relative bg-gray-100 w-full">
      <section id="dashboard-view" class="view-section hidden p-4 md:p-8">
        <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-2xl font-bold text-green-900">System Overview</h2>
            <p class="text-sm text-gray-500">Live snapshot across admissions, revenue, and canteen</p>
          </div>
          <div class="text-left md:text-right">
            <div class="text-lg font-semibold text-green-900" id="current-date"></div>
            <div class="text-sm text-gray-600" id="current-time"></div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 w-full">
          <div class="kpi-card kpi-accent-shamrock flex-1 cursor-pointer hover:shadow-lg transition-all" onclick="window.navigateTo('patients-view')">
            <div class="flex items-start justify-between">
              <div><div class="text-sm text-gray-700">Total Patients</div><div class="metric-number text-2xl md:text-3xl font-extrabold mt-2" id="dash-total">0</div></div>
              <div class="kpi-icon"><i class="fas fa-users"></i></div>
            </div>
          </div>
          <div class="kpi-card kpi-accent-amber flex-1 cursor-pointer hover:shadow-lg transition-all" onclick="openAdmissionsModal()">
            <div class="flex items-start justify-between">
              <div><div class="text-sm text-gray-700">Admissions (<span id="dash-month-label">Month</span>)</div><div class="metric-number text-2xl md:text-3xl font-extrabold mt-2" id="dash-today">0</div></div>
              <div class="kpi-icon"><i class="fas fa-hospital-user"></i></div>
            </div>
          </div>
          <div id="dash-income-card" class="kpi-card kpi-accent-sky flex-1 cursor-pointer hover:shadow-lg transition-all" onclick="window.navigateTo('expenses-view')" style="display: none">
            <div class="flex items-start justify-between">
              <div><div class="text-sm text-gray-700">Income (Fees)</div><div class="metric-number text-2xl md:text-3xl font-extrabold mt-2" id="dash-income">0</div></div>
              <div class="kpi-icon"><i class="fas fa-chart-line"></i></div>
            </div>
          </div>
          <div id="dash-canteen-card" class="kpi-card kpi-accent-forest flex-1 cursor-pointer hover:shadow-lg transition-all" onclick="window.navigateTo('canteen-view')" style="display: none">
            <div class="flex items-start justify-between">
              <div><div class="text-sm text-gray-700">Canteen Sales (<span id="dash-canteen-month">Month</span>)</div><div class="metric-number text-2xl md:text-3xl font-extrabold mt-2" id="dash-canteen-sales">0</div></div>
              <div class="kpi-icon"><i class="fas fa-utensils"></i></div>
            </div>
          </div>
        </div>

        <div id="dash-call-meeting-section" class="mt-10 pt-10 border-t border-emerald-100" style="display: none">
          <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div><h3 class="text-xl md:text-2xl font-bold text-green-900">Call & Meeting Tracker</h3><p class="text-sm text-gray-500">Track calls, meetings, and text interactions</p></div>
            <div class="flex gap-2">
              <button onclick="printCallMeetingChart()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold shadow-md text-sm"><i class="fas fa-print mr-2"></i>Print</button>
              <button onclick="openCallMeetingModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-md text-sm"><i class="fas fa-plus mr-2"></i>Add Entry</button>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="lg:col-span-2 kpi-card" style="background: linear-gradient(135deg, #ffffff 0%, #f7fdf9 100%); border-color: rgba(16, 185, 129, 0.2);">
              <h3 class="text-lg font-bold text-green-900 mb-4">Activity Overview</h3>
              <div class="relative h-64 md:h-80"><canvas id="callMeetingChart"></canvas></div>
            </div>
            <div class="space-y-4">
              <div class="kpi-card" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-color: rgba(59, 130, 246, 0.2);"><div class="text-sm text-gray-700 font-bold">Total Calls</div><div class="text-3xl font-bold text-blue-600 mt-2" id="stat-calls">0</div></div>
              <div class="kpi-card" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-color: rgba(16, 185, 129, 0.2);"><div class="text-sm text-gray-700 font-bold">Total Meetings</div><div class="text-3xl font-bold text-emerald-600 mt-2" id="stat-meetings">0</div></div>
              <div class="kpi-card" style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border-color: rgba(168, 85, 247, 0.2);"><div class="text-sm text-gray-700 font-bold">Total Texts</div><div class="text-3xl font-bold text-purple-600 mt-2" id="stat-texts">0</div></div>
            </div>
          </div>
          <div class="kpi-card overflow-hidden" style="padding: 0; border-color: rgba(16, 185, 129, 0.2)">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-emerald-100">
                <thead class="bg-gradient-to-r from-emerald-700 to-emerald-600 text-white"><tr><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Name</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Admission Date</th><th class="px-6 py-3 text-center whitespace-nowrap font-semibold">Scheduled Date</th><th class="px-6 py-3 text-center whitespace-nowrap font-semibold">Type</th><th class="px-6 py-3 text-center whitespace-nowrap font-semibold">Actions</th></tr></thead>
                <tbody id="call_meeting_table_body" class="divide-y divide-emerald-50"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="expenses-view" class="view-section hidden p-4 md:p-8">
        <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div><h2 class="text-2xl font-bold text-green-900">Expenses</h2><p class="text-sm text-gray-500">Track incoming and outgoing money.</p></div>
          <div><button id="add-expense-btn" onclick="openExpenseModal()" class="hidden bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-md"><i class="fas fa-plus mr-2"></i>Add Entry</button></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="kpi-card" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-color: rgba(16, 185, 129, 0.2);"><div class="text-sm text-gray-700 font-bold">Incoming (Month)</div><div class="text-3xl font-bold text-emerald-700 mt-2" id="expense-incoming">0</div></div>
          <div class="kpi-card" style="background: linear-gradient(135deg, #fee2e2 0%, #fecdd3 100%); border-color: rgba(248, 113, 113, 0.2);"><div class="text-sm text-gray-700 font-bold">Outgoing (Month)</div><div class="text-3xl font-bold text-red-600 mt-2" id="expense-outgoing">0</div></div>
          <div class="kpi-card" style="background: linear-gradient(135deg, #e0f2fe 0%, #bfdbfe 100%); border-color: rgba(59, 130, 246, 0.2);"><div class="text-sm text-gray-700 font-bold">Net (Month)</div><div class="text-3xl font-bold text-blue-700 mt-2" id="expense-net">0</div></div>
        </div>
        <div class="kpi-card overflow-hidden" style="padding: 0; border-color: rgba(16, 185, 129, 0.2)">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-emerald-100">
              <thead class="bg-gradient-to-r from-emerald-700 to-emerald-600 text-white"><tr><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Date</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Category</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Type</th><th class="px-6 py-3 text-right whitespace-nowrap font-semibold">Amount</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Note</th><th class="px-6 py-3 text-center whitespace-nowrap font-semibold">Actions</th></tr></thead>
              <tbody id="expenses-table-body" class="divide-y divide-emerald-50"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="accounts-view" class="view-section hidden p-4 md:p-8">
        <h2 class="text-xl md:text-2xl font-bold mb-6 text-green-800"><i class="fas fa-file-invoice-dollar mr-2"></i>Accounts & Discharge</h2>
        <div class="kpi-card overflow-hidden" style="padding: 0; border-color: rgba(16, 185, 129, 0.2)">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-emerald-100">
              <thead class="bg-gradient-to-r from-emerald-700 to-emerald-600 text-white"><tr><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Patient Name</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Father Name</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Admission</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Monthly Fee</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Canteen Total</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Actions</th></tr></thead>
              <tbody id="accounts-table-body" class="divide-y divide-emerald-50"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="patients-view" class="view-section hidden p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between mb-4 gap-4">
          <h2 class="text-2xl font-bold">Patients Directory</h2>
          <div class="flex flex-col sm:flex-row gap-2">
            <button onclick="document.getElementById('export-modal').classList.remove('hidden')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition font-semibold shadow-md text-center"><i class="fas fa-file-excel mr-2"></i>Export</button>
            <button id="add-new-patient-btn" onclick="openNewAdmissionModal()" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700 transition font-semibold shadow-md text-center"><i class="fas fa-plus mr-2"></i>New Admission</button>
          </div>
        </div>
        <div class="kpi-card overflow-hidden" style="padding: 0; border-color: rgba(16, 185, 129, 0.2)">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-emerald-100">
              <thead class="bg-gradient-to-r from-emerald-700 to-emerald-600 text-white"><tr id="patients-table-headers"><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Name</th><th id="header-id" class="px-6 py-3 text-left whitespace-nowrap font-semibold">ID No</th><th id="header-contact" class="px-6 py-3 text-left whitespace-nowrap font-semibold">Contact</th><th id="header-fee" class="px-6 py-3 text-left whitespace-nowrap font-semibold">Fee</th><th class="px-6 py-3 text-center whitespace-nowrap font-semibold">Status</th><th class="px-6 py-3 text-right whitespace-nowrap font-semibold">Actions</th></tr></thead>
              <tbody id="patients-table-body" class="divide-y divide-emerald-50"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="patient-detail-view" class="view-section hidden p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between mb-4 gap-4">
          <button onclick="navigateTo('patients-view')" class="text-green-600 font-bold self-start"><i class="fas fa-arrow-left mr-2"></i>Back</button>
          <div class="flex gap-2">
            <button onclick="window.print()" class="bg-white border px-4 py-2 rounded text-sm"><i class="fas fa-print mr-2"></i>Print</button>
            <button onclick="document.getElementById('save-det-btn-submit').click()" class="bg-green-600 text-white px-4 py-2 rounded text-sm">Save</button>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 bg-white p-6 rounded shadow">
            <form id="patient-details-form" onsubmit="savePatientDetails(event)">
              <input type="submit" id="save-det-btn-submit" class="hidden" />
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <input id="det-name" class="border p-2 rounded" placeholder="Name" /><input id="det-father" class="border p-2 rounded" placeholder="Father Name" /><input id="det-admission" type="date" class="border p-2 rounded" /><input id="det-id" class="border p-2 rounded" placeholder="ID" /><input id="det-age" class="border p-2 rounded" placeholder="Age" /><input id="det-cnic" class="border p-2 rounded" placeholder="CNIC" /><input id="det-contact" class="border p-2 rounded" placeholder="Contact" /><input id="det-guardian" class="border p-2 rounded" placeholder="Guardian" /><input id="det-relation" class="border p-2 rounded" placeholder="Relation" />
                <div class="md:col-span-2 lg:col-span-3"><input id="det-address" class="border p-2 w-full rounded" placeholder="Address" /></div>
                <div class="md:col-span-2 lg:col-span-3"><textarea id="det-complaint" class="border p-2 w-full rounded" placeholder="Complaint"></textarea></div>
                <input id="det-drug" class="border p-2 rounded" placeholder="Drug" /><input id="det-prev" class="border p-2 rounded" placeholder="Prev Admissions" />
                <div class="md:col-span-2 lg:col-span-3 mt-4 border-t pt-4 bg-gray-50 p-4">
                  <h4 class="text-xs font-bold text-gray-500 mb-2 uppercase">Financial Settings (Admin Only)</h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input id="det-fee" class="financial-input border p-2 rounded" placeholder="Monthly Fee" />
                    <input id="det-allowance" class="financial-input border p-2 rounded" placeholder="Canteen Allowance" />
                    <div class="md:col-span-2"><label class="flex items-center gap-3 p-3 bg-white border border-emerald-200 rounded-lg cursor-pointer"><input type="checkbox" id="det-laundry-status" class="financial-input w-5 h-5 text-emerald-600 border-gray-300 rounded focus:ring-2 focus:ring-emerald-500" /><span id="det-laundry-label" class="text-sm font-semibold text-gray-700">Enable Laundry Service</span></label></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">Laundry Amount (PKR)</label><input id="det-laundry-amount" type="number" class="financial-input border p-2 rounded w-full" placeholder="3500" /></div>
                  </div>
                </div>
              </div>
            </form>
            <div class="mt-6 border-t pt-4">
              <div class="flex border-b mb-4">
                <button onclick="showTab('notes')" id="notes-tab-btn" class="flex-1 py-2 text-green-700 border-b-2 border-green-700 font-bold">Notes</button>
                <button onclick="showTab('records')" id="records-tab-btn" class="flex-1 py-2 text-gray-500">Medical Records</button>
              </div>
              <div id="tab-notes">
                <div id="session-notes-list" class="h-64 overflow-y-auto border p-2 mb-2 bg-gray-50 rounded"></div>
                <form onsubmit="addSessionNote(event)" class="flex gap-2"><input id="new-session-note-input" class="flex-1 border p-2 rounded" placeholder="Add Note..." /><button class="bg-green-600 text-white px-4 rounded">Add</button></form>
              </div>
              <div id="tab-med" class="hidden">
                <div id="medical-records-list" class="h-64 overflow-y-auto border p-2 mb-2 bg-gray-50 rounded"></div>
                <form onsubmit="addMedicalRecord(event)" class="grid gap-2"><input id="new-med-title" class="border p-2 rounded" placeholder="Title" /><textarea id="new-med-details" class="border p-2 rounded" placeholder="Details"></textarea><button class="bg-green-600 text-white p-2 rounded">Add Record</button></form>
              </div>
            </div>
          </div>
          <div class="col-span-1 space-y-6">
            <div id="call-info-panel" class="bg-white p-6 rounded shadow border-t-4 border-green-600">
              <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800"><i class="fas fa-phone-alt mr-2"></i>Weekly Call</h3><span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">Active</span></div>
              <div id="next-call-display" class="mb-6 p-4 bg-green-50 rounded border border-green-100"></div>
              <div><h4 class="text-xs font-bold text-gray-400 uppercase">Calendar</h4><div id="mini-calendar" class="calendar-grid"></div></div>
            </div>
          </div>
        </div>
      </section>

      <section id="canteen-view" class="view-section hidden p-4 md:p-8">
        <h2 class="text-2xl font-bold mb-6">Canteen Sales</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div id="canteen-sales-panel" class="col-span-1 bg-white p-6 rounded shadow h-fit">
            <h3 class="font-bold mb-4">Record Sale</h3>
            <form onsubmit="recordCanteenSale(event)">
              <select id="canteen-patient-select" class="w-full border p-2 mb-2 rounded"></select>
              <input id="canteen-item-input" class="w-full border p-2 mb-2 rounded" placeholder="Item" />
              <input id="canteen-amount-input" type="number" class="w-full border p-2 mb-2 rounded" placeholder="Amount" />
              <button class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded transition font-semibold shadow-md">Record</button>
            </form>
          </div>
          <div id="canteen-breakdown-table-container" class="col-span-2 kpi-card overflow-hidden" style="padding: 0; border-color: rgba(16, 185, 129, 0.2)">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-emerald-100">
                <thead class="bg-gradient-to-r from-emerald-700 to-emerald-600 text-white"><tr><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Patient</th><th class="px-6 py-3 whitespace-nowrap font-semibold">Allowance</th><th class="px-6 py-3 whitespace-nowrap font-semibold">Sales</th><th class="px-6 py-3 whitespace-nowrap font-semibold">Balance</th></tr></thead>
                <tbody id="canteen-breakdown-body" class="divide-y divide-emerald-50"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="user-management-view" class="view-section hidden p-4 md:p-8">
        <h2 class="text-2xl font-bold mb-6">User Management</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="col-span-1 bg-white p-6 rounded shadow h-fit">
            <h3 class="font-bold mb-4">Create User</h3>
            <form onsubmit="createUser(event)">
              <input name="new-name" class="w-full border p-2 mb-2 rounded" placeholder="Name" required />
              <input name="new-username" class="w-full border p-2 mb-2 rounded" placeholder="Username" required />
              <input name="new-password" type="password" class="w-full border p-2 mb-2 rounded" placeholder="Password" required />
              <select name="new-role" class="w-full border p-2 mb-4 rounded"><option value="Admin">Admin</option><option value="Doctor">Doctor</option><option value="Psychologist">Psychologist</option><option value="Canteen">Canteen</option></select>
              <button class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded transition font-semibold shadow-md">Create</button>
            </form>
          </div>
          <div class="col-span-2 kpi-card overflow-hidden" style="padding: 0; border-color: rgba(16, 185, 129, 0.2)">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-emerald-100">
                <thead class="bg-gradient-to-r from-emerald-700 to-emerald-600 text-white"><tr><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Name</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">User</th><th class="px-6 py-3 text-left whitespace-nowrap font-semibold">Role</th><th class="px-6 py-3 whitespace-nowrap font-semibold">Action</th></tr></thead>
                <tbody id="user-table-body" class="divide-y divide-emerald-50"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="utility-bills-view" class="view-section hidden p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
          <div><h2 class="text-2xl font-bold text-green-900"><i class="fas fa-file-invoice mr-2"></i>Utility Bills</h2><p class="text-sm text-gray-500">Manage pending utility payments.</p></div>
          <div class="bg-red-50 border border-red-200 px-6 py-3 rounded-xl flex flex-col items-end min-w-[200px]"><span class="text-xs font-bold text-red-600 uppercase tracking-wide">Total Payable</span><span id="bill-total-display" class="text-2xl font-extrabold text-red-700">PKR 0</span></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="col-span-1 bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
            <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Add New Bill</h3>
            <form onsubmit="addUtilityBill(event)">
              <div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bill Type</label><select id="bill-type" class="w-full border bg-gray-50 p-2 rounded focus:ring-2 focus:ring-green-500" required><option value="Electricity">Electricity (WAPDA)</option><option value="Gas">Gas (SNGPL)</option><option value="Internet">Internet / PTCL</option><option value="Water">Water</option><option value="Rent">Rent</option><option value="Maintenance">Maintenance</option><option value="Other">Other</option></select></div>
              <div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Amount (PKR)</label><input id="bill-amount" type="number" class="w-full border p-2 rounded" placeholder="0" required /></div>
              <div class="mb-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Due Date</label><input id="bill-due-date" type="date" class="w-full border p-2 rounded" required /></div>
              <div class="mb-4"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Reference No / Note</label><input id="bill-ref" type="text" class="w-full border p-2 rounded" placeholder="e.g. Ref ID or Meter No" /></div>
              <button class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-bold shadow transition"><i class="fas fa-plus mr-2"></i> Add Bill</button>
            </form>
          </div>
          <div class="col-span-1 lg:col-span-2">
            <div id="bills-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div id="bills-empty-state" class="hidden flex flex-col items-center justify-center py-12 text-gray-400 bg-white rounded-xl border border-dashed border-gray-300"><i class="fas fa-check-circle text-4xl mb-3 text-green-200"></i><p>No pending bills. Great job!</p></div>
          </div>
        </div>
      </section>

      <section id="team-view" class="view-section hidden p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
          <div><h2 class="text-2xl font-bold text-green-900"><i class="fas fa-users-cog mr-2"></i>Our Team</h2><p class="text-sm text-gray-500">Manage staff details, designations, and timings.</p></div>
          <div><button onclick="openEmployeeModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition font-semibold shadow-md"><i class="fas fa-plus mr-2"></i> Add Employee</button></div>
        </div>
        <div class="kpi-card overflow-hidden" style="padding: 0; border-color: rgba(16, 185, 129, 0.2)">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-emerald-100">
              <thead class="bg-gradient-to-r from-emerald-700 to-emerald-600 text-white"><tr><th class="px-4 py-3 text-center whitespace-nowrap font-semibold text-xs uppercase">S.No</th><th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">Name</th><th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">Designation</th><th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">Pay</th><th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">Advance</th><th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">Duty Timings</th><th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">Joining Date</th><th class="px-4 py-3 text-left whitespace-nowrap font-semibold text-xs uppercase">Contact Info</th><th class="px-4 py-3 text-center whitespace-nowrap font-semibold text-xs uppercase">Actions</th></tr></thead>
              <tbody id="team-table-body" class="divide-y divide-emerald-50 bg-white"></tbody>
            </table>
          </div>
        </div>
      </section>

      <div id="employee-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-[95%] md:w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-green-900" id="emp-modal-title"><i class="fas fa-user-tie mr-2"></i>Add Employee</h3><button onclick="closeEmployeeModal()" class="text-gray-400 hover:text-gray-600 text-2xl"><i class="fas fa-times"></i></button></div>
          <form id="employee-form" onsubmit="saveEmployee(event)">
            <input type="hidden" id="emp-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label class="block text-sm font-semibold text-gray-700 mb-1">Name *</label><input type="text" id="emp-name" class="w-full border p-2 rounded" placeholder="Full Name" required /></div>
              <div><label class="block text-sm font-semibold text-gray-700 mb-1">Designation *</label><input type="text" id="emp-designation" class="w-full border p-2 rounded" placeholder="e.g. CEO, Medical Officer, Cook" required /></div>
              <div><label class="block text-sm font-semibold text-gray-700 mb-1">Pay</label><input type="text" id="emp-pay" class="w-full border p-2 rounded" placeholder="Salary Amount" /></div>
              <div><label class="block text-sm font-semibold text-gray-700 mb-1">Advance</label><input type="text" id="emp-advance" class="w-full border p-2 rounded" placeholder="Advance Taken" /></div>
              <div><label class="block text-sm font-semibold text-gray-700 mb-1">Duty Timings</label><input type="text" id="emp-timings" class="w-full border p-2 rounded" placeholder="e.g. 9am to 5pm" /></div>
              <div><label class="block text-sm font-semibold text-gray-700 mb-1">Date of Joining</label><input type="text" id="emp-joining" class="w-full border p-2 rounded" placeholder="e.g. September 4, 2024" /></div>
              <div><label class="block text-sm font-semibold text-gray-700 mb-1">CNIC #</label><input type="text" id="emp-cnic" class="w-full border p-2 rounded" placeholder="XXXXX-XXXXXXX-X" /></div>
              <div><label class="block text-sm font-semibold text-gray-700 mb-1">Phone #</label><input type="text" id="emp-phone" class="w-full border p-2 rounded" placeholder="03XX-XXXXXXX" /></div>
            </div>
            <div class="flex gap-3 mt-6"><button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition"><i class="fas fa-save mr-2"></i>Save Details</button><button type="button" onclick="closeEmployeeModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel</button></div>
          </form>
        </div>
      </div>
    </main>

    <div id="export-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded shadow w-[90%] max-w-sm mx-4">
        <h3 class="font-bold mb-4">Export Data</h3>
        <button onclick="downloadExcel()" class="bg-green-600 text-white w-full py-2 rounded">Download Excel</button>
        <button onclick="document.getElementById('export-modal').classList.add('hidden')" class="w-full py-2 mt-2 text-gray-500">Cancel</button>
      </div>
    </div>
    <script>
      async function downloadExcel() {
        try {
          const res = await fetch('/api/export', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fields: 'all' }) });
          if (res.ok) { const b = await res.blob(); const u = window.URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'patients.xlsx'; document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(u); document.getElementById('export-modal').classList.add('hidden'); }
          else { const errorData = await res.json(); showSuccessModal('Export failed: ' + (errorData.error || 'Unknown error'), true); }
        } catch (error) { showSuccessModal('Export error: ' + error.message, true); }
      }
    </script>
    
    <div id="new-admission-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-xl shadow-2xl w-[95%] md:w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-green-900"><i class="fas fa-user-plus mr-2"></i>New Patient Admission</h3><button onclick="document.getElementById('new-admission-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 text-2xl"><i class="fas fa-times"></i></button></div>
        <form id="new-admission-form" onsubmit="addNewPatient(event)">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-semibold text-gray-700 mb-1">Patient Name *</label><input type="text" id="new-patient-name" class="w-full border border-gray-300 p-2 rounded" placeholder="Enter full name" required /></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-1">Father's Name</label><input type="text" id="new-patient-father" class="w-full border border-gray-300 p-2 rounded" placeholder="Enter father's name" /></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-1">Admission Date *</label><input type="date" id="new-patient-admission" class="w-full border border-gray-300 p-2 rounded" required /></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-1">Age</label><input type="number" id="new-patient-age" class="w-full border border-gray-300 p-2 rounded" placeholder="Enter age" /></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-1">CNIC</label><input type="text" id="new-patient-cnic" class="w-full border border-gray-300 p-2 rounded" placeholder="XXXXX-XXXXXXX-X" /></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-1">Contact Number</label><input type="tel" id="new-patient-contact" class="w-full border border-gray-300 p-2 rounded" placeholder="03XX-XXXXXXX" /></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-1">Guardian Name</label><input type="text" id="new-patient-guardian" class="w-full border border-gray-300 p-2 rounded" placeholder="Enter guardian name" /></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-1">Monthly Fee</label><input type="number" id="new-patient-fee" class="w-full border border-gray-300 p-2 rounded" placeholder="0" value="0" /></div>
            <div class="md:col-span-2"><label class="block text-sm font-semibold text-gray-700 mb-1">Address</label><textarea id="new-patient-address" class="w-full border border-gray-300 p-2 rounded" placeholder="Enter complete address" rows="2"></textarea></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-1">Monthly Allowance</label><input type="number" id="new-patient-allowance" class="w-full border border-gray-300 p-2 rounded" placeholder="3000" value="3000" /></div>
            <div class="md:col-span-2"><div class="flex items-center gap-3 p-3 bg-emerald-50 border border-emerald-200 rounded-lg"><input type="checkbox" id="new-patient-laundry-status" class="w-5 h-5 text-emerald-600 border-gray-300 rounded focus:ring-2 focus:ring-emerald-500 cursor-pointer" /><label for="new-patient-laundry-status" class="flex-1 cursor-pointer"><span class="text-sm font-semibold text-gray-700">Enable Laundry Service</span><p class="text-xs text-gray-600 mt-0.5">If checked, laundry fee will be set to PKR 3,500 (can be changed later)</p></label></div></div>
            <div id="laundry-amount-container" class="hidden"><label class="block text-sm font-semibold text-gray-700 mb-1">Laundry Amount (PKR)</label><input type="number" id="new-patient-laundry-amount" class="w-full border border-gray-300 p-2 rounded" placeholder="3500" value="3500" /></div>
          </div>
          <div class="flex gap-3 mt-6"><button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition"><i class="fas fa-check mr-2"></i>Admit Patient</button><button type="button" onclick="document.getElementById('new-admission-modal').classList.add('hidden'); document.getElementById('new-admission-form').reset();" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition"><i class="fas fa-times mr-2"></i>Cancel</button></div>
        </form>
      </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white p-8 rounded-xl shadow-2xl w-[90%] max-w-md mx-4">
        <div class="text-center mb-6"><div class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4"><i class="fas fa-exclamation-triangle text-3xl text-red-600"></i></div><h3 class="text-xl font-bold text-gray-900 mb-2">Confirm Action</h3><p id="confirm-message" class="text-gray-600">Are you sure?</p></div>
        <div class="flex gap-3"><button id="confirm-ok-btn" onclick="window.confirmCallback(true)" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">Confirm</button><button onclick="window.confirmCallback(false)" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel</button></div>
      </div>
    </div>

    <div id="success-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white p-8 rounded-xl shadow-2xl w-[90%] max-w-md mx-4 text-center transform transition-all">
        <div id="success-icon" class="mb-4"><i class="fas fa-check-circle text-6xl text-green-500"></i></div>
        <p id="success-message" class="text-xl font-semibold text-gray-800 mb-6">Success!</p>
        <button onclick="document.getElementById('success-modal').classList.add('hidden')" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700 transition">OK</button>
      </div>
    </div>

    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded shadow w-[90%] max-w-sm mx-4">
        <h3 class="font-bold mb-4">Change Password</h3>
        <form onsubmit="changePassword(event)">
          <input name="old-password" type="password" class="w-full border p-2 mb-2 rounded" placeholder="Old Password" />
          <input name="new-password-user" type="password" class="w-full border p-2 mb-4 rounded" placeholder="New Password" />
          <button class="bg-blue-600 text-white w-full py-2 rounded">Update</button>
        </form>
        <button onclick="document.getElementById('password-modal').classList.add('hidden')" class="w-full py-2 mt-2 text-gray-500">Cancel</button>
      </div>
    </div>

    <div id="call_meeting_modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-[90%] mx-4">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Add Call/Meeting Entry</h2>
        <form onsubmit="saveCallMeetingEntry(event)" id="call_meeting_form">
          <div class="mb-4"><label class="block text-sm font-bold text-gray-700 mb-1">Name</label><input id="cm-name" type="text" class="w-full border p-2 rounded" required /></div>
          <div class="mb-4"><label class="block text-sm font-bold text-gray-700 mb-1">Admission Date</label><input id="cm-admission-date" type="date" class="w-full border p-2 rounded" required /></div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div><label class="block text-sm font-bold text-gray-700 mb-1">Scheduled Date</label><input id="cm-day" type="number" min="1" max="31" class="w-full border p-2 rounded" required /></div>
            <div><label class="block text-sm font-bold text-gray-700 mb-1">Type</label><select id="cm-type" class="w-full border p-2 rounded" required><option value="Call">Call</option><option value="Meeting">Meeting</option><option value="Text">Text</option></select></div>
          </div>
          <button type="submit" class="bg-green-600 text-white w-full py-2 rounded">Save</button>
        </form>
        <button onclick="document.getElementById('call_meeting_modal').classList.add('hidden')" class="w-full py-2 mt-2 text-gray-500">Cancel</button>
      </div>
    </div>
    
    <div id="cm-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white p-8 rounded-xl shadow-2xl w-[90%] max-w-md mx-4">
        <div class="text-center mb-6"><div class="mx-auto w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mb-4"><i class="fas fa-question-circle text-3xl text-emerald-600"></i></div><h3 class="text-xl font-bold text-gray-900 mb-2">Delete entry?</h3><p class="text-gray-600">This will remove the entry permanently.</p></div>
        <div class="flex gap-3"><button onclick="confirmDeleteCallMeeting()" class="flex-1 bg-emerald-600 text-white py-3 rounded-lg font-semibold hover:bg-emerald-700 transition">Delete</button><button onclick="closeCallMeetingDeleteModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel</button></div>
      </div>
    </div>

    <div id="admissions-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
      <div class="bg-white p-8 rounded-xl shadow-2xl w-[95%] md:w-full max-w-xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-4"><div><h3 class="text-xl font-bold text-gray-900">Admissions (This Month)</h3></div><button onclick="closeAdmissionsModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button></div>
        <div id="admissions-month-body" class="max-h-80 overflow-y-auto divide-y divide-emerald-50"></div>
        <div class="mt-6 text-right"><button onclick="closeAdmissionsModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition">Close</button></div>
      </div>
    </div>

    <div id="expense-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-[90%] mx-4">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Add Expense</h2>
        <form onsubmit="saveExpense(event)" id="expense-form">
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div><label class="block text-sm font-bold text-gray-700 mb-1">Type</label><select id="exp-type" class="w-full border p-2 rounded" required><option value="outgoing">Outgoing</option><option value="incoming">Incoming</option></select></div>
            <div><label class="block text-sm font-bold text-gray-700 mb-1">Amount</label><input id="exp-amount" type="number" class="w-full border p-2 rounded" required /></div>
          </div>
          <div class="mb-4"><label class="block text-sm font-bold text-gray-700 mb-1">Category</label><input id="exp-category" type="text" class="w-full border p-2 rounded" required /></div>
          <div class="mb-4"><label class="block text-sm font-bold text-gray-700 mb-1">Date</label><input id="exp-date" type="date" class="w-full border p-2 rounded" /></div>
          <div class="mb-4"><label class="block text-sm font-bold text-gray-700 mb-1">Note</label><textarea id="exp-note" class="w-full border p-2 rounded" rows="2"></textarea></div>
          <button type="submit" class="bg-emerald-600 text-white w-full py-2 rounded">Save</button>
        </form>
        <button onclick="document.getElementById('expense-modal').classList.add('hidden')" class="w-full py-2 mt-2 text-gray-500">Cancel</button>
      </div>
    </div>
    
    <div id="printable-discharge-slip"></div>
    <div id="printable-area"></div>
  </body>
</html>